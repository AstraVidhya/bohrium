ROOT=../../..
CPU=$(ROOT)/ve/cpu
BDIR=$(CPU)/bdir
BH_PYTHON=python

#
# Generate Doxygen documentation
docs:
	mkdir -p $(CPU)/doc/output
	cd $(CPU) && doxygen doc/cpu_engine.doxy

#
# Generate autogenerated code.
gen:
	cd $(CPU)/autogen && ./gen.py
	cp $(CPU)/autogen/output/block_compose.cpp $(CPU)/
	cp $(CPU)/autogen/output/utils_mapping.cpp $(CPU)/
	cp $(CPU)/autogen/output/specializer_cexpression.cpp $(CPU)/
	cp $(CPU)/autogen/output/tac.cpp $(CPU)/tac.h
	rm $(CPU)/autogen/output/*.cpp

#
# Remove installed stuff related to the cpu-engine
purge:
	rm -rf ~/.local/share/bh/templates
	rm -rf ~/.local/var/bh/kernels
	rm -rf ~/.local/var/bh/objects
	rm -rf ~/.local/var/bh/scripts
	rm -f ~/.local/lib/libbh_ve_cpu.so
	rm -f ~/.local/include/tac.h

#
# "Reinstall" the cpu-engine
reset: purge install

#
# "Install the cpu-engine
install: gen
	mkdir -p $(BDIR)
	cd $(BDIR) && cmake $(ROOT) -DCMAKE_INSTALL_PREFIX=~/.local && make && make install

#
# Clean up the build-files
clean:
	rm -rf $(BDIR) core trace-*.txt flow*.dot flow*.html graph-*.dot $(CPU)/doc/output $(CPU)/autogen/output/*

#
# Utilities
move_fused:
	python $(CPU)/tools/move_code.py ~/.local/var/bh/kernels/ /tmp/code/fused

move_sij:
	python $(CPU)/tools/move_code.py ~/.local/var/bh/kernels/ /tmp/code/sij

prep_fused:
	mkdir -p /tmp/code/fused
	rm -rf /tmp/code/fused/*.c

prep_sij:
	mkdir -p /tmp/code/sij
	rm -rf /tmp/code/sij/*.c

#
# Benchmarks
black_sij:
	BH_CORE_VCACHE_SIZE=0 OMP_NUM_THREADS=1 BH_VE_CPU_JIT_FUSION=0 BH_VE_CPU_JIT_DUMPSRC=1 $(BH_PYTHON) $(ROOT)/benchmark/Python/black_scholes.py --size=5000000*10 --bohrium=True

black_fused:
	BH_CORE_VCACHE_SIZE=0 OMP_NUM_THREADS=1 BH_VE_CPU_JIT_FUSION=1 BH_VE_CPU_JIT_DUMPSRC=1 $(BH_PYTHON) $(ROOT)/benchmark/Python/black_scholes.py --size=5000000*10 --bohrium=True

synth_sij:
	BH_CORE_VCACHE_SIZE=0 OMP_NUM_THREADS=1 BH_VE_CPU_JIT_FUSION=0 BH_VE_CPU_JIT_DUMPSRC=1 $(BH_PYTHON) $(ROOT)/benchmark/Python/synth.py --size=20000000*20 --bohrium=True

synth_fused:
	BH_CORE_VCACHE_SIZE=0 OMP_NUM_THREADS=1 BH_VE_CPU_JIT_FUSION=1 BH_VE_CPU_JIT_DUMPSRC=1 $(BH_PYTHON) $(ROOT)/benchmark/Python/synth.py --size=20000000*20 --bohrium=True

